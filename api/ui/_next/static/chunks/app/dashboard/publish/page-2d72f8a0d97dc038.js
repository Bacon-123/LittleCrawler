(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[966],{9486:function(e,t,s){Promise.resolve().then(s.bind(s,1846))},1846:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return E}});var a=s(7437),i=s(2265),n=s(9376),l=s(5265),r=s(5035),c=s(3168),o=s(3649),d=s(9008),h=s(7985),u=s(3706),m=s(5455),p=s(9900),x=s(4555),g=s(974),f=s(1513),w=s(6472),j=s(5069),b=s(8139),N=s(4362),v=s(2660),y=s(9322),S=s(1671),C=s(2489),k=s(332),z=s(1217),P=s(4743),O=s(3247),_=s(1837);function E(){let e=(0,n.useRouter)(),{token:t}=(0,N.a)(),s=(0,i.useRef)(null),[E,T]=(0,i.useState)(""),[I,A]=(0,i.useState)(""),[D,J]=(0,i.useState)([]),[R,Z]=(0,i.useState)([]),[L,U]=(0,i.useState)(!1),[B,F]=(0,i.useState)(!1),[q,G]=(0,i.useState)(!1),[H,V]=(0,i.useState)(""),[Y,K]=(0,i.useState)([]),[Q,W]=(0,i.useState)(null),[M,X]=(0,i.useState)(null),{isOpen:$,onOpen:ee,onClose:et}=(0,l.q)(),es=(0,i.useCallback)(async e=>{if(e&&0!==e.length&&t){U(!0),W(null);try{for(let s of Array.from(e)){if(!s.type.startsWith("image/"))throw Error("不支持的文件类型: ".concat(s.name));if(D.length>=9)throw Error("最多上传9张图片");let e=await _.oD.uploadImage(t,s);J(t=>[...t,e])}}catch(e){W(e.message||"上传失败")}finally{U(!1)}}},[t,D.length]),ea=(0,i.useCallback)(async e=>{if(t)try{await _.oD.deleteImage(t,e),J(t=>t.filter(t=>t.file_id!==e))}catch(e){console.error("删除图片失败:",e)}},[t]),ei=(0,i.useCallback)(async()=>{if(H.trim()&&t){G(!0),W(null);try{let e=await _.oD.searchTopic(t,H.trim());K(e.topics)}catch(e){W(e.message||"搜索话题失败")}finally{G(!1)}}},[t,H]),en=(0,i.useCallback)(e=>{if(!R.find(t=>t.id===e.id)){if(R.length>=5){W("最多添加5个话题");return}Z(t=>[...t,e]),et()}},[R,et]),el=(0,i.useCallback)(e=>{Z(t=>t.filter(t=>t.id!==e))},[]),er=(0,i.useCallback)(async()=>{if(t){if(!E.trim()){W("请输入标题");return}if(0===D.length){W("请至少上传一张图片");return}F(!0),W(null),X(null);try{let e=await _.oD.publishNote(t,{title:E.trim(),desc:I.trim(),image_ids:D.map(e=>e.file_id),topic_ids:R.map(e=>e.id)});e.success&&(X("笔记发布成功！ID: ".concat(e.note_id)),T(""),A(""),J([]),Z([]))}catch(e){W(e.message||"发布失败")}finally{F(!1)}}},[t,E,I,D,R]);return(0,a.jsxs)("div",{className:"min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 p-6",children:[(0,a.jsxs)("div",{className:"max-w-2xl mx-auto",children:[(0,a.jsxs)("div",{className:"flex items-center gap-4 mb-6",children:[(0,a.jsx)(r.A,{isIconOnly:!0,variant:"light",onPress:()=>e.push("/dashboard"),className:"text-white/70 hover:text-white",children:(0,a.jsx)(v.Z,{size:20})}),(0,a.jsx)("h1",{className:"text-2xl font-bold text-white",children:"发布笔记"}),(0,a.jsx)(c.z,{color:"warning",variant:"flat",size:"sm",children:"小红书"})]}),Q&&(0,a.jsx)(o.w,{className:"mb-4 bg-danger-50 border border-danger-200",children:(0,a.jsxs)(d.G,{className:"flex-row items-center gap-2 py-3",children:[(0,a.jsx)(y.Z,{className:"text-danger",size:18}),(0,a.jsx)("span",{className:"text-danger text-sm",children:Q})]})}),M&&(0,a.jsx)(o.w,{className:"mb-4 bg-success-50 border border-success-200",children:(0,a.jsxs)(d.G,{className:"flex-row items-center gap-2 py-3",children:[(0,a.jsx)(S.Z,{className:"text-success",size:18}),(0,a.jsx)("span",{className:"text-success text-sm",children:M})]})}),(0,a.jsx)(o.w,{className:"bg-white/10 backdrop-blur-md border border-white/20",children:(0,a.jsxs)(d.G,{className:"gap-6 p-6",children:[(0,a.jsx)(h.Y,{label:"笔记标题",placeholder:"输入笔记标题（必填）",value:E,onValueChange:T,maxLength:20,description:"".concat(E.length,"/20"),classNames:{label:"text-white/70",input:"text-white",description:"text-white/50"}}),(0,a.jsx)(u.Y,{label:"笔记内容",placeholder:"输入笔记内容...",value:I,onValueChange:A,maxLength:1e3,minRows:4,maxRows:10,description:"".concat(I.length,"/1000"),classNames:{label:"text-white/70",input:"text-white",description:"text-white/50"}}),(0,a.jsx)(m.j,{className:"bg-white/20"}),(0,a.jsxs)("div",{children:[(0,a.jsxs)("p",{className:"text-sm text-white/70 mb-3",children:["图片 (",D.length,"/9)"]}),(0,a.jsxs)("div",{className:"grid grid-cols-3 gap-3",children:[D.map(e=>(0,a.jsxs)("div",{className:"relative aspect-square",children:[(0,a.jsx)(p.J,{src:e.url,alt:"uploaded",className:"w-full h-full object-cover rounded-lg"}),(0,a.jsx)(r.A,{isIconOnly:!0,size:"sm",color:"danger",className:"absolute top-1 right-1 min-w-6 w-6 h-6",onPress:()=>ea(e.file_id),children:(0,a.jsx)(C.Z,{size:14})})]},e.file_id)),D.length<9&&(0,a.jsx)("div",{className:"aspect-square border-2 border-dashed border-white/30 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:border-white/50 transition-colors",onClick:()=>{var e;return null===(e=s.current)||void 0===e?void 0:e.click()},children:L?(0,a.jsx)(x.c,{size:"sm",color:"white"}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(k.Z,{className:"text-white/50 mb-1",size:24}),(0,a.jsx)("span",{className:"text-white/50 text-xs",children:"添加图片"})]})})]}),(0,a.jsx)("input",{ref:s,type:"file",accept:"image/*",multiple:!0,className:"hidden",onChange:e=>es(e.target.files)})]}),(0,a.jsx)(m.j,{className:"bg-white/20"}),(0,a.jsxs)("div",{children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,a.jsxs)("p",{className:"text-sm text-white/70",children:["话题 (",R.length,"/5)"]}),(0,a.jsx)(r.A,{size:"sm",variant:"flat",startContent:(0,a.jsx)(z.Z,{size:14}),onPress:ee,className:"text-white/70",children:"添加话题"})]}),(0,a.jsxs)("div",{className:"flex flex-wrap gap-2",children:[R.map(e=>(0,a.jsxs)(c.z,{onClose:()=>el(e.id),variant:"flat",color:"secondary",children:["#",e.name]},e.id)),0===R.length&&(0,a.jsx)("span",{className:"text-white/40 text-sm",children:"暂无话题"})]})]}),(0,a.jsx)(m.j,{className:"bg-white/20"}),(0,a.jsx)(r.A,{color:"primary",size:"lg",startContent:!B&&(0,a.jsx)(P.Z,{size:18}),onPress:er,isLoading:B,isDisabled:!E.trim()||0===D.length,className:"w-full",children:B?"发布中...":"发布笔记"})]})})]}),(0,a.jsx)(g.R,{isOpen:$,onClose:et,size:"lg",children:(0,a.jsxs)(f.A,{className:"bg-slate-800 text-white",children:[(0,a.jsx)(w.k,{children:"搜索话题"}),(0,a.jsxs)(j.I,{children:[(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)(h.Y,{placeholder:"输入话题关键词",value:H,onValueChange:V,onKeyDown:e=>"Enter"===e.key&&ei(),classNames:{input:"text-white"}}),(0,a.jsx)(r.A,{isIconOnly:!0,color:"primary",onPress:ei,isLoading:q,children:(0,a.jsx)(O.Z,{size:18})})]}),(0,a.jsx)("div",{className:"mt-4 max-h-60 overflow-y-auto",children:Y.length>0?(0,a.jsx)("div",{className:"space-y-2",children:Y.map(e=>(0,a.jsx)("div",{className:"p-3 rounded-lg bg-white/10 hover:bg-white/20 cursor-pointer transition-colors",onClick:()=>en(e),children:(0,a.jsxs)("span",{className:"text-secondary",children:["#",e.name]})},e.id))}):(0,a.jsx)("p",{className:"text-center text-white/50 py-8",children:H?"未找到相关话题":"输入关键词搜索话题"})})]}),(0,a.jsx)(b.R,{children:(0,a.jsx)(r.A,{variant:"light",onPress:et,children:"取消"})})]})})]})}},4362:function(e,t,s){"use strict";s.d(t,{H:function(){return r},a:function(){return c}});var a=s(7437),i=s(2265),n=s(1837);let l=(0,i.createContext)(void 0);function r(e){let{children:t}=e,[s,r]=(0,i.useState)(null),[c,o]=(0,i.useState)(null),[d,h]=(0,i.useState)(!0);(0,i.useEffect)(()=>{let e=localStorage.getItem("token");e?(o(e),n.iJ.getCurrentUser(e).then(e=>{r(e)}).catch(()=>{localStorage.removeItem("token"),o(null)}).finally(()=>{h(!1)})):h(!1)},[]);let u=async e=>{let t=await n.iJ.login(e);o(t.access_token),r(t.user),localStorage.setItem("token",t.access_token)};return(0,a.jsx)(l.Provider,{value:{user:s,token:c,isAuthenticated:!!c&&!!s,isLoading:d,login:u,logout:()=>{c&&n.iJ.logout(c).catch(console.error),o(null),r(null),localStorage.removeItem("token")}},children:t})}function c(){let e=(0,i.useContext)(l);if(!e)throw Error("useAuth must be used within AuthProvider");return e}},1837:function(e,t,s){"use strict";s.d(t,{BQ:function(){return i},Bl:function(){return c},Z9:function(){return r},iJ:function(){return l},oD:function(){return o}});let a=()=>window.location.origin,i=()=>{{let e="https:"===window.location.protocol?"wss:":"ws:";return"".concat(e,"//").concat(window.location.host)}};async function n(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},s=arguments.length>2?arguments[2]:void 0,i={"Content-Type":"application/json",...t.headers};s&&(i.Authorization="Bearer ".concat(s));let n=await fetch("".concat(a()).concat(e),{...t,headers:i});if(!n.ok)throw Error((await n.json().catch(()=>({detail:"Unknown error"}))).detail||"HTTP ".concat(n.status));return n.json()}let l={login:e=>n("/api/auth/login",{method:"POST",body:JSON.stringify(e)}),getCurrentUser:e=>n("/api/auth/me",{},e),logout:e=>n("/api/auth/logout",{method:"POST"},e)},r={getStatus:e=>n("/api/crawler/status",{},e),start:(e,t)=>n("/api/crawler/start",{method:"POST",body:JSON.stringify(t)},e),stop:e=>n("/api/crawler/stop",{method:"POST"},e),getPlatforms:e=>n("/api/crawler/platforms",{},e)},c={getFiles:(e,t,s)=>{let a=new URLSearchParams;t&&a.append("platform",t),s&&a.append("file_type",s);let i=a.toString();return n("/api/data/files".concat(i?"?".concat(i):""),{},e)},getFileContent:function(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10;return n("/api/data/files/".concat(encodeURIComponent(t),"?preview=true&limit=").concat(s),{},e)},export:(e,t,s)=>fetch("".concat(a(),"/api/data/").concat(t,"/export?format=").concat(s),{headers:{Authorization:"Bearer ".concat(e)}}).then(e=>e.blob()),delete:(e,t,s)=>n("/api/data/".concat(t,"/").concat(s),{method:"DELETE"},e)},o={getStatus:e=>n("/api/publisher/status",{},e),searchTopic:function(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;return n("/api/publisher/topic/search",{method:"POST",body:JSON.stringify({keyword:t,page:s,page_size:20})},e)},uploadImage:async(e,t)=>{let s=new FormData;s.append("file",t);let i=await fetch("".concat(a(),"/api/publisher/upload"),{method:"POST",headers:{Authorization:"Bearer ".concat(e)},body:s});if(!i.ok)throw Error((await i.json().catch(()=>({detail:"Upload failed"}))).detail||"HTTP ".concat(i.status));return i.json()},deleteImage:(e,t)=>n("/api/publisher/upload/".concat(encodeURIComponent(t)),{method:"DELETE"},e),publishNote:(e,t)=>n("/api/publisher/publish",{method:"POST",body:JSON.stringify(t)},e)}}},function(e){e.O(0,[69,192,354,500,637,971,117,744],function(){return e(e.s=9486)}),_N_E=e.O()}]);